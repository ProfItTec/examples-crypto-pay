# 📦 Примеры интеграции платёжного шлюза

Эта директория содержит полные примеры кода для интеграции с криптовалютным платёжным шлюзом.

---


## ⚠️ Важные требования API

### Обязательные заголовки

Все запросы к платёжному шлюзу требуют **ДВА** заголовка:

```http
X-API-Key: pk_your_api_key      # API ключ мерчанта
X-Site-Key: sk_your_site_key    # Ключ сайта (у каждого сайта свой кошелёк!)
```

### Обязательные параметры

| Параметр | Описание | Где используется |
|----------|----------|------------------|
| `user_id` | Идентификатор пользователя на вашем сайте | Все создания инвойсов |
| `fiat_amount` | Сумма в фиатной валюте | Hosted Checkout |
| `fiat_currency` | Код валюты (USD, EUR, RUB, AMD...) | Hosted Checkout |

### Важные поля в ответе

| Поле | Описание |
|------|----------|
| `amount_to_pay` | **Уникальная сумма для оплаты!** Клиент должен отправить именно эту сумму |
| `payment_id` | Уникальный ID платежа (memo/tag) — запасной способ идентификации |

---

## 🔄 Два способа интеграции

### Способ 1: 💳 API Integration

> **Пользователь остаётся на сайте мерчанта**

- Полный контроль над UI и UX
- Требует больше кода
- Модальное окно с QR-кодом на вашем сайте

### Способ 2: 🔗 Hosted Checkout

> **Пользователь переходит на страницу платёжного шлюза**

- Быстрый старт с минимумом кода
- Автоматическая конвертация фиат → крипта
- Готовый современный UI

---

## 📊 Схемы интеграции

### 💳 API Integration (пользователь на сайте мерчанта)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   ┌──────────────────┐                           ┌──────────────────┐       │
│   │                  │                           │  ПЛАТЁЖНЫЙ ШЛЮЗ  │       │
│   │    ПОЛЬЗОВАТЕЛЬ  │                           │                  │       │
│   │    (браузер)     │                           │                  │       │
│   └────────┬─────────┘                           └────────┬─────────┘       │
│            │                                              │                 │
│            │ 1. Ввод суммы в КРИПТЕ                       │                 │
│            │    user_id, сеть, валюта                     │                 │
│            ▼                                              │                 │
│   ┌──────────────────┐                                    │                 │
│   │                  │  2. POST /api/payments/            │                 │
│   │    ФРОНТЕНД      │     create-invoice                 │                 │
│   │    МЕРЧАНТА      │ ─────────────────────────────►     │                 │
│   │                  │     { user_id, amount,             │                 │
│   │                  │       currency, network }          │                 │
│   └────────┬─────────┘                           ┌────────┴─────────┐       │
│            │                                     │                  │       │
│            │                                     │    СЕРВЕР        │       │
│            │                                     │    МЕРЧАНТА      │       │
│            │                                     │                  │       │
│            │                                     └────────┬─────────┘       │
│            │                                              │                 │
│            │                           3. POST /api/v1/invoices             │
│            │                              Headers:                          │
│            │                              - X-API-Key: pk_...               │
│            │                              - X-Site-Key: sk_...              │
│            │                              Body: { user_id, amount, ... }    │
│            │                                              ▼                 │
│            │                                     ┌──────────────────┐       │
│            │                                     │  ПЛАТЁЖНЫЙ ШЛЮЗ  │       │
│            │  4. Ответ:                          │     (API)        │       │
│            │     { address,                      │                  │       │
│            │       amount_to_pay,  <── ВАЖНО!    │                  │       │
│            │       payment_id }    <── ВАЖНО!    │                  │       │
│            │ ◄────────────────────────────────── └────────┬─────────┘       │
│            │                                              │                 │
│            ▼                                              │                 │
│   ┌──────────────────┐                                    │                 │
│   │  ┌────────────┐  │                                    │                 │
│   │  │            │  │  5. Поллинг статуса                │                 │
│   │  │  МОДАЛЬНОЕ │  │     каждые 5 секунд                │                 │
│   │  │    ОКНО    │  │ ◄─────────────────────────────────►│                 │
│   │  │            │  │                                    │                 │
│   │  │  [QR код]  │  │                                    │                 │
│   │  │            │  │                                    │                 │
│   │  │  Сумма:    │  │                                    │                 │
│   │  │  0.05234   │  │  ← amount_to_pay (уникальная!)     │                 │
│   │  │  ETH       │  │                                    │                 │
│   │  │            │  │                                    │                 │
│   │  │  ID:       │  │                                    │                 │
│   │  │  PID-A7F3  │  │  ← payment_id (memo/tag)           │                 │
│   │  │            │  │                                    │                 │
│   │  └────────────┘  │                                    │                 │
│   │                  │  6. Webhook: payment.confirmed     │                 │
│   │                  │     { usd_amount: 150.00, ... }    │                 │
│   │                  │ ◄──────────────────────────────────│                 │
│   └──────────────────┘                                    │                 │
│                                                           │                 │
│            │                                              │                 │
│            │ 7. Баланс += usd_amount                      │                 │
│            ▼                                              │                 │
│   ┌──────────────────┐                                    │                 │
│   │   ✅ УСПЕХ!      │                                    │                 │
│   │   Баланс: $150   │  ← Баланс всегда в USD             │                 │
│   └──────────────────┘                                    │                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Порядок действий:**

| Шаг | Действие | Описание |
|-----|----------|----------|
| 1 | Пользователь заполняет форму | Вводит сумму в крипте, `user_id` обязателен |
| 2 | Фронтенд → Сервер мерчанта | `POST /api/payments/create-invoice` |
| 3 | Сервер мерчанта → Шлюз | `POST /api/v1/invoices` с **X-API-Key** и **X-Site-Key** |
| 4 | Ответ с данными | `address`, `amount_to_pay` (уникальная!), `payment_id` |
| 5 | Поллинг статуса | Каждые 5 сек проверка статуса |
| 6 | Webhook | Шлюз отправляет `payment.confirmed` с `usd_amount` |
| 7 | Обновление баланса | Баланс += `usd_amount` (всегда в USD!) |

---

### 🔗 Hosted Checkout (редирект на платёжный шлюз)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   ┌──────────────────┐                                                      │
│   │                  │                                                      │
│   │    ПОЛЬЗОВАТЕЛЬ  │                                                      │
│   │    (браузер)     │                                                      │
│   │                  │                                                      │
│   └────────┬─────────┘                                                      │
│            │                                                                │
│            │ 1. Ввод суммы в ФИАТЕ!                                         │
│            │    Выбор: 10 EUR → USDT на Tron                              │
│            │    user_id обязателен                                          │
│            ▼                                                                │
│   ┌──────────────────┐                                                      │
│   │                  │  2. POST /api/payments/checkout-url                  │
│   │    ФРОНТЕНД      │     { user_id, fiat_amount: 10,                    │
│   │    МЕРЧАНТА      │       fiat_currency: "EUR",                          │
│   │                  │       currency: "USDT", network: "tron" }            │
│   │                  │ ──────────────────────────────►                      │
│   └────────┬─────────┘                           ┌──────────────────┐       │
│            │                                     │    СЕРВЕР        │       │
│            │                                     │    МЕРЧАНТА      │       │
│            │  3. { checkout_url }                │                  │       │
│            │ ◄────────────────────────────────── └──────────────────┘       │
│            │                                                                │
│            │  4. window.location.href = checkout_url                        │
│            │                                                                │
│            │  ═══════════════════════════════════════════════════════════   │
│            │                    РЕДИРЕКТ БРАУЗЕРА                           │
│            │  ═══════════════════════════════════════════════════════════   │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │                                                                 │       │
│   │                     ФРОНТЕНД ПЛАТЁЖНОГО ШЛЮЗА                   │       │
│   │                                                                 │       │
│   │    ┌─────────────────────────────────────────────────────┐      │       │
│   │    │                                                     │      │       │
│   │    │                 Оплата #abc123                      │      │       │
│   │    │                                                     │      │       │
│   │    │     ┌───────────────────────────────────────┐       │      │       │
│   │    │     │ Получатель: casino-azino.com          │       │      │       │
│   │    │     │ Назначение: Пополнение счёта          │       │      │       │
│   │    │     └───────────────────────────────────────┘       │      │       │
│   │    │                                                     │      │       │
│   │    │              ┌─────────────┐                        │      │       │
│   │    │              │   QR КОД    │                        │      │       │
│   │    │              └─────────────┘                        │      │       │
│   │    │                                                     │      │       │
│   │    │    ══════════════════════════════════════════════   │      │       │
│   │    │    КОНВЕРТАЦИЯ НА СТОРОНЕ ШЛЮЗА:                    │      │       │
│   │    │    10 EUR → 10.85 USDT                              │      │       │
│   │    │    ══════════════════════════════════════════════   │      │       │
│   │    │                                                     │      │       │
│   │    │    Отправьте: 10.8523 USDT  ← amount_to_pay         │      │       │
│   │    │    Payment ID: PID-A7F3B2C1 ← для memo/tag          │      │       │
│   │    │                                                     │      │       │
│   │    │    ≈ 10 EUR | ≈ $10.85 USD                          │      │       │
│   │    │                                                     │      │       │
│   │    │              ⏱ Осталось: 58:42                      │      │       │
│   │    │                                                     │      │       │
│   │    └─────────────────────────────────────────────────────┘      │       │
│   │                                                                 │       │
│   └─────────────────────────────────────────────────────────────────┘       │
│                                                                             │
│            │                                              │                 │
│            │  5. Пользователь                             │                 │
│            │     отправляет крипту                        │                 │
│            │                                              ▼                 │
│            │                                     ┌──────────────────┐       │
│            │                                     │   BLOCKCHAIN     │       │
│            │                                     │   (транзакция)   │       │
│            │                                     └────────┬─────────┘       │
│            │                                              │ 6. Мониторинг   │
│            │                                              ▼                 │
│            │                                     ┌──────────────────┐       │
│            │                                     │  ПЛАТЁЖНЫЙ ШЛЮЗ  │       │
│            │  7. Redirect на success_url         │   (бэкенд)       │       │
│            │ ◄─────────────────────────────────  │                  │       │
│            │                                     └────────┬─────────┘       │
│            ▼                                              │                 │
│   ┌──────────────────┐                                    │                 │
│   │    ФРОНТЕНД      │   8. Webhook: payment.confirmed    │                 │
│   │    МЕРЧАНТА      │     { usd_amount: 10.85,           │                 │
│   │  (success page)  │       fiat_amount: 10,             │                 │
│   │                  │       fiat_currency: "EUR" }       │                 │
│   │                  │ ◄──────────────────────────────────│                 │
│   └──────────────────┘                           ┌────────┴─────────┐       │
│                                                  │    СЕРВЕР        │       │
│            │                                     │    МЕРЧАНТА      │       │
│            │ 9. Баланс += usd_amount             │   (webhook)      │       │
│            ▼                                     └──────────────────┘       │
│   ┌──────────────────┐                                                      │
│   │   ✅ УСПЕХ!      │                                                      │
│   │   Баланс: $10.85 │  ← Баланс всегда в USD                               │
│   └──────────────────┘                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Порядок действий:**

| Шаг | Действие | Описание |
|-----|----------|----------|
| 1 | Ввод суммы в **ФИАТЕ** | Пользователь вводит сумму в своей валюте (RUB, USD, EUR...) |
| 2 | Запрос checkout URL | `{ user_id, fiat_amount, fiat_currency, currency, network }` |
| 3 | Получение URL | Сервер генерирует подписанный URL с параметрами |
| 4 | Редирект | Браузер переходит на страницу шлюза |
| 5 | Оплата | Пользователь видит сумму в крипте (конвертация на шлюзе!) |
| 6 | Мониторинг | Шлюз отслеживает транзакцию в блокчейне |
| 7 | Redirect назад | После оплаты редирект на `success_url` мерчанта |
| 8 | Webhook | `payment.confirmed` с `usd_amount`, `fiat_amount`, `fiat_currency` |
| 9 | Обновление | Баланс += `usd_amount` (всегда в USD!) |

---

## 🆚 Сравнение способов

| Параметр | API Integration | Hosted Checkout |
|----------|-----------------|-----------------|
| **UI** | Ваш (модальное окно) | Готовый (страница шлюза) |
| **Ввод суммы** | В криптовалюте | В фиатной валюте |
| **Конвертация** | Не требуется | Автоматически на шлюзе |
| **user_id** | ✅ Обязателен | ✅ Обязателен |
| **X-Site-Key** | ✅ Обязателен | ✅ В подписи |
| **Сложность** | Средняя | Низкая |

---

## 🚀 Быстрый старт

### Шаг 1: Запуск платёжного шлюза

```bash
# Терминал 1: Бэкенд шлюза
cd /path/to/kazik-back
npm run dev

# Терминал 2: Фронтенд шлюза
cd /path/to/kazik-back/frontend
npm run dev
```

### Шаг 2: Настройка сервера мерчанта

```bash
cd examples/merchant-server

# Вариант A: Использовать config.js
cp config.example.js config.js
nano config.js  # заполнить ключи

# Вариант B: Использовать .env
cp .env.example .env
nano .env  # заполнить ключи

# Установить зависимости и запустить
npm install
npm run dev
```

### Шаг 3: Запуск фронтенда мерчанта

```bash
cd examples/merchant-frontend

npm install
npm run dev
```

### Шаг 4: Тестирование

Откройте в браузере: **http://localhost:3001**

| Кнопка | Что тестирует |
|--------|---------------|
| 💳 **Оплатить на сайте** | API Integration (сумма в крипте) |
| 🔗 **Перейти к оплате** | Hosted Checkout (сумма в фиате) |

---

## ⚙️ Конфигурация

### Параметры для сервера мерчанта

| Параметр | Описание | Где получить |
|----------|----------|--------------|
| `PAYMENT_GATEWAY_URL` | URL API шлюза
| `PAYMENT_GATEWAY_API_KEY` | API ключ мерчанта
| `PAYMENT_GATEWAY_WEBHOOK_SECRET` | Секрет для подписей | Генерируется при создании мерчанта |
| `PAYMENT_GATEWAY_SITE_KEY` | Ключ сайта (ОБЯЗАТЕЛЕН!)
| `PAYMENT_GATEWAY_WS_TOKEN` | WebSocket токен (опционально)

### Пример .env

```env
PORT=4000
PAYMENT_GATEWAY_URL=
PAYMENT_GATEWAY_API_KEY=pk_live_abc123...
PAYMENT_GATEWAY_WEBHOOK_SECRET=whsec_xyz789...
PAYMENT_GATEWAY_SITE_KEY=site_def456...     # ОБЯЗАТЕЛЕН!
PAYMENT_GATEWAY_WS_TOKEN=                    # опционально
```

### Пример config.js

```javascript
module.exports = {
  port: 4000,
  paymentGatewayUrl: 'https://api.kazik.graniumlab.com',
  apiKey: 'pk_live_abc123...',
  webhookSecret: 'whsec_xyz789...',
  siteKey: 'site_def456...',      // ОБЯЗАТЕЛЕН!
  websocketToken: null,           // опционально
  enableWebSocket: false,
};
```

---

## 🔑 Идентификация платежей

Так как один адрес используется для всех платежей сайта, система использует **3 способа идентификации**:

### 1️⃣ Уникальная сумма (amount_to_pay)

```
Запрошено: 10.85 USDT
К оплате:  10.8523 USDT  ← уникальный "хвост"
```

### 2️⃣ Payment ID (memo/tag)

```
PID-A7F3B2C1
```

Клиент добавляет этот код в поле memo/комментарий в кошельке.

### 3️⃣ Fuzzy Match (резервный)

Если сумма отличается ≤0.5% от ожидаемой, а адрес и время совпадают.

**⚠️ Важно:** Всегда показывайте клиенту `amount_to_pay`, а не `amount`!

---

## 📚 Дополнительная документация

- [merchant-server/README.md](./merchant-server/README.md) — Документация сервера мерчанта
- [EXAMPLES.md](../EXAMPLES.md) — Примеры кода на разных языках
- [MERCHANT_INTEGRATION.md](../MERCHANT_INTEGRATION.md) — Полное руководство по интеграции

---

## 🆘 Частые вопросы

### Ошибка "X-Site-Key is required"

Добавьте заголовок `X-Site-Key` во все запросы к API шлюза:

```javascript
headers: {
  'X-API-Key': 'pk_...',
  'X-Site-Key': 'site_...',
}
```

### Ошибка "user_id is required"

Параметр `user_id` обязателен для всех инвойсов:

```javascript
// API Integration
{ user_id: 'user-123', amount: 100, currency: 'USDT', network: 'ethereum' }

// Hosted Checkout
{ user_id: 'user-123', fiat_amount: 10, fiat_currency: 'EUR', currency: 'USDT', network: 'tron' }
```

### Webhook не приходит

1. Проверьте что `webhook_url` настроен у мерчанта
2. URL должен быть доступен из интернета (не localhost)
3. Для локальной разработки используйте [ngrok](https://ngrok.com/)

### Ошибка подписи webhook

1. Проверьте что `webhookSecret` совпадает с секретом в шлюзе
2. Не модифицируйте тело запроса перед проверкой подписи

### Инвойс не создаётся

1. Проверьте что API ключ и Site Key валидные
2. Проверьте что комбинация сеть+валюта поддерживается
3. `GET /api/v1/networks` покажет доступные опции

### Баланс показывается неправильно

Баланс всегда в **USD**! Используйте `usd_amount` из webhook:

```javascript
// Webhook payload
{ 
  usd_amount: 10.85,        // Используйте ЭТО для баланса
  amount_received: 10.8523, // Сумма в крипте
  fiat_amount: 10,        // Оригинал в фиате (если был)
  fiat_currency: 'EUR'
}

// Обновление баланса
userBalance += parseFloat(data.usd_amount);
```

